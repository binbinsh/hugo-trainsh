<!DOCTYPE html>
<html lang="{{ site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}">
<head>
  {{ partial "head.html" . }}
</head>
<body class="font-sans antialiased min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="mb-8">
      {{ partial "header.html" . }}
    </header>
    <main class="mb-12">
      {{ block "main" . }}{{ end }}
    </main>
    <footer class="border-t border-[var(--color-border)] pt-6 text-center text-sm text-[var(--color-muted)]">
      {{ partial "footer.html" . }}
    </footer>
  </div>
  {{ if .Store.Get "hasMermaid" }}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    const resolveThemeConfig = () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const cs = getComputedStyle(document.documentElement);
      const fg = (cs.getPropertyValue('--color-fg') || (isDark ? '#e2e8f0' : '#0f172a')).trim();
      const bg = (cs.getPropertyValue('--color-bg') || (isDark ? '#0f172a' : '#fcfcfd')).trim();
      const surface = (cs.getPropertyValue('--color-surface') || (isDark ? '#1e293b' : '#f8fafc')).trim();
      const border = (cs.getPropertyValue('--color-border') || (isDark ? '#334155' : '#e2e8f0')).trim();
      const accent = (cs.getPropertyValue('--color-accent') || (isDark ? '#60a5fa' : '#2563eb')).trim();
      return {
        theme: 'base',
        themeVariables: {
          background: bg,
          mainBkg: bg,
          primaryColor: surface,
          primaryTextColor: fg,
          primaryBorderColor: border,
          lineColor: accent,
          secondaryColor: surface,
          tertiaryColor: surface,
          textColor: fg
        }
      };
    };
    const renderMermaid = () => {
      const config = resolveThemeConfig();
      mermaid.initialize({ startOnLoad: false, securityLevel: 'loose', ...config });
      mermaid.run({ querySelector: '.mermaid' });
    };
    // Initial render
    renderMermaid();
    // Re-render on theme change (html[data-theme] mutations)
    const mo = new MutationObserver((mutations) => {
      for (const m of mutations) {
        if (m.type === 'attributes' && m.attributeName === 'data-theme') {
          renderMermaid();
          break;
        }
      }
    });
    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
    // Also listen for a custom event in case other scripts dispatch it
    window.addEventListener('themechange', renderMermaid);
  </script>
  {{ end }}
</body>
</html>
