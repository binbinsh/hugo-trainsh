console.log('This site was generated by Hugo.');

document.addEventListener('DOMContentLoaded', () => {
  const upvoteContainers = Array.from(document.querySelectorAll('[data-upvote]'));
  if (upvoteContainers.length) {
    const hasMoved = { value: false };
    const started = Date.now();
    const movementHandler = () => { hasMoved.value = true; };
    document.addEventListener('mousemove', movementHandler, { once: true });
    document.addEventListener('touchmove', movementHandler, { once: true });

    upvoteContainers.forEach((container) => {
      const slug = container.getAttribute('data-slug');
      const endpoint = container.getAttribute('data-endpoint');
      const infoEndpoint = container.getAttribute('data-info-endpoint');
      const form = container.querySelector('form');
      const button = container.querySelector('.upvote-button');
      const countEl = container.querySelector('.upvote-count');
      if (!slug || !endpoint || !infoEndpoint || !form || !button || !countEl) {
        return;
      }

      const updateState = ({ upvote_count, upvoted }) => {
        if (typeof upvote_count === 'number') {
          countEl.textContent = upvote_count.toString();
          button.classList.remove('upvote-button--cool', 'upvote-button--warm', 'upvote-button--hot');
          if (upvote_count >= 100) {
            button.classList.add('upvote-button--hot');
          } else if (upvote_count >= 10) {
            button.classList.add('upvote-button--warm');
          } else {
            button.classList.add('upvote-button--cool');
          }
        }
        if (upvoted) {
          button.disabled = true;
          button.classList.add('upvote-button--active');
          button.title = 'Toasted';
        }
      };

      fetch(`${infoEndpoint}?slug=${encodeURIComponent(slug)}`, { credentials: 'include' })
        .then((resp) => resp.ok ? resp.json() : null)
        .then((data) => {
          if (!data) return;
          updateState(data);
        })
        .catch(() => {});

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (button.disabled) return;
        if (!hasMoved.value || Date.now() - started < 2000) return;

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ slug }),
          credentials: 'include'
        })
          .then((resp) => resp.ok ? resp.json() : null)
          .then((data) => {
            if (!data) return;
            updateState(data);
            if (typeof data.upvote_count === 'number') {
              countEl.textContent = data.upvote_count.toString();
            } else {
              const current = parseInt(countEl.textContent || '0', 10) || 0;
              countEl.textContent = String(current + 1);
            }
          })
          .catch(() => {});
      });
    });
  }
  // Mobile nav toggle
  const navToggleBtn = document.querySelector('[data-nav-toggle]');
  const navEl = document.querySelector('[data-nav]');
  if (navToggleBtn && navEl) {
    navToggleBtn.addEventListener('click', () => {
      const open = navEl.classList.toggle('is-open');
      navToggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
  }

  const toc = document.querySelector('.toc-dropdown');
  if (toc) {
    toc.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.tagName === 'A') {
        toc.open = false;
      }
    });
  }

  // Archive/Home search wiring
  const searchInput = document.getElementById('archive-search');
  const groupsEl = document.getElementById('archive-groups');
  const resultsEl = document.getElementById('archive-results');
  if (searchInput && resultsEl) {
    let fuseInstance = null;
    let indexData = null;

    const renderResults = (items) => {
      if (!Array.isArray(items)) return;
      if (items.length === 0) {
        resultsEl.innerHTML = '<p>No results</p>';
        return;
      }
      const html = items.map((r) => {
        const item = r.item || r; // support raw array or Fuse result
        const title = item.title || '';
        const date = item.date || '';
        const author = item.author || '';
        const link = item.permalink || '#';
        const summary = item.summary || '';
        return `
          <article class="archive-result">
            <div class="meta-line"><time class="date">${date}</time>${author ? ` by <span class="author">${author}</span>` : ''}</div>
            <h3><a href="${link}">${title}</a></h3>
            <p class="summary">${summary}</p>
          </article>
        `;
      }).join('');
      resultsEl.innerHTML = html;
    };

    const showGroups = () => {
      if (groupsEl) groupsEl.hidden = false;
      resultsEl.hidden = true;
    };
    const showResults = () => {
      if (groupsEl) groupsEl.hidden = true;
      resultsEl.hidden = false;
    };

    // Make search accessible
    searchInput.setAttribute('aria-label', 'Search posts');
    searchInput.setAttribute('role', 'search');

    const initFuse = async () => {
      if (fuseInstance) return fuseInstance;
      if (!indexData) {
        try {
          const res = await fetch('/index.json', { cache: 'no-store' });
          if (!res.ok) return null;
          indexData = await res.json();
        } catch (e) {
          // Fail silently to avoid breaking page
          return null;
        }
      }
      if (!Array.isArray(indexData)) return null;
      const options = {
        includeScore: true,
        ignoreLocation: true,
        minMatchCharLength: 2,
        threshold: 0.3,
        keys: [
          { name: 'title', weight: 2 },
          { name: 'summary', weight: 1 },
          { name: 'tags', weight: 0.5 },
          { name: 'categories', weight: 0.5 },
          { name: 'content', weight: 0.25 }
        ]
      };
      if (window.Fuse) {
        fuseInstance = new window.Fuse(indexData, options);
      }
      return fuseInstance;
    };

    searchInput.addEventListener('input', async (ev) => {
      const q = (ev.target.value || '').trim();
      if (q.length === 0) {
        showGroups();
        return;
      }
      const fuse = await initFuse();
      if (!fuse) return;
      const results = fuse.search(q).slice(0, 50);
      renderResults(results);
      showResults();
    });

    // If homepage hides groups, ensure initial state shows results hidden
    if (!groupsEl) {
      resultsEl.hidden = true;
    }
  }

  // PhotoSwipe lightbox for all images in article content
  (async () => {
    const article = document.querySelector('article.content');
    if (!article) return;

    try {
      // Helper to reliably get intrinsic dimensions; falls back to probing the src
      const getImageDimensions = (src, imgEl) => new Promise((resolve) => {
        const w = (imgEl && imgEl.naturalWidth) || 0;
        const h = (imgEl && imgEl.naturalHeight) || 0;
        if (w > 0 && h > 0) {
          resolve({ width: w, height: h });
          return;
        }
        const probe = new Image();
        probe.onload = () => {
          resolve({
            width: probe.naturalWidth || 1600,
            height: probe.naturalHeight || 900
          });
        };
        probe.onerror = () => resolve({ width: 1600, height: 900 });
        probe.src = src;
      });

      const { default: PhotoSwipeLightbox } = await import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.esm.min.js');

      // Primary lightbox for images with data-pswp-width attributes
      const lightbox = new PhotoSwipeLightbox({
        gallery: 'article.content',
        children: 'a[data-pswp-width]',
        wheelToZoom: true,
        pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.esm.min.js')
      });
      lightbox.init();

      // Handle all lightbox-image anchors (including those without data-pswp-width)
      const lightboxAnchors = Array.from(article.querySelectorAll('a.lightbox-image:not([data-pswp-width])'))
        .map(a => ({ a, img: a.querySelector('img') }))
        .filter(x => x.img);

      if (lightboxAnchors.length) {
        const { default: LB } = await import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.esm.min.js');
        const lbLinks = new LB({
          wheelToZoom: true,
          pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.esm.min.js')
        });
        lbLinks.init();
        lightboxAnchors.forEach(({ a, img }) => {
          a.style.cursor = 'zoom-in';
          a.addEventListener('click', async (e) => {
            e.preventDefault();
            const src = a.getAttribute('href');
            const dims = await getImageDimensions(src, img);
            lbLinks.loadAndOpen(0, [{ src, width: dims.width, height: dims.height, alt: img.alt || '' }]);
          });
        });
      }

      // Fallback for images not wrapped by any anchor
      const orphanImgs = Array.from(article.querySelectorAll('img:not(a img)'));
      if (orphanImgs.length) {
        const { default: LB } = await import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.esm.min.js');
        const lb = new LB({
          wheelToZoom: true,
          pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.esm.min.js')
        });
        lb.init();
        orphanImgs.forEach((img) => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', async () => {
            const src = img.currentSrc || img.src;
            const dims = await getImageDimensions(src, img);
            lb.loadAndOpen(0, [{ src, width: dims.width, height: dims.height, alt: img.alt || '' }]);
          });
        });
      }
    } catch (e) {
      // no-op if CDN blocked
    }
  })();

  // Copy-to-clipboard for code blocks
  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('[data-copy-code]');
    if (!btn) return;
    const wrapper = btn.closest('.codeblock');
    if (!wrapper) return;
    const pre = wrapper.querySelector('.highlight pre');
    if (!pre) return;
    try {
      const text = pre.textContent || '';
      await navigator.clipboard.writeText(text);
      const original = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(() => { btn.textContent = original; }, 1200);
    } catch (e) {
      // ignore
    }
  });

  // Word wrap toggle for code blocks
  document.addEventListener('click', (ev) => {
    const btn = ev.target.closest('[data-wrap-toggle]');
    if (!btn) return;
    const wrapper = btn.closest('.codeblock');
    if (!wrapper) return;
    const isWrapped = wrapper.classList.toggle('wrapped');
    btn.textContent = isWrapped ? 'Nowrap' : 'Wrap';
  });
  
  // Theme toggle
  const themeBtn = document.querySelector('[data-theme-toggle]');
  if (themeBtn) {
    const root = document.documentElement;
    const applyTheme = (theme) => {
      root.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeBtn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme');
    };
    const current = root.getAttribute('data-theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(current);
    themeBtn.addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
      // Notify listeners (e.g., mermaid re-render)
      try { window.dispatchEvent(new Event('themechange')); } catch (_) {}
    });
  }
});
